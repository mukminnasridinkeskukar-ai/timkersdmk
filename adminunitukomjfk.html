<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Jabatan Fungsional</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0}
header{background:#1e3a8a;color:#fff;padding:15px}
.login,.content{max-width:1300px;margin:auto;padding:20px}
img{width:45px;height:45px;border-radius:50%;object-fit:cover}
button{padding:8px;background:#2563eb;color:#fff;border:none}
</style>
</head>

<body>

<header><h2>üìä Dashboard Jabatan Fungsional</h2></header>

<div class="login" id="login">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div class="content" id="content" style="display:none">
  <h3 id="unit"></h3>

  <table id="tbl" class="display">
    <thead>
      <tr>
        <th>Foto</th><th>Nama</th><th>NIK</th><th>NIP</th><th>WA</th>
        <th>Unit</th><th>Jenis</th><th>Jenjang</th><th>Pangkat</th>
        <th>PAK</th><th>STR</th><th>Kategori</th>
        <th>Jabatan Tujuan</th><th>Jenjang Tujuan</th><th>Keputusan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="chart1"></canvas>
  <canvas id="chart2"></canvas>

  <button onclick="exportPDF()">üñ®Ô∏è PDF</button>
  <button onclick="tv()">üì∫ TV Wall</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzfX9xoOZ-_PPLQ7-IvT2FO-laeL8qcAMJH7Lp97o4BuBNkceEuk-AhWLdrKvng4h0QmQ/exec";
let UNIT="";

function login(){
 fetch(`${API}?action=login&username=${user.value}&password=${pass.value}`)
  .then(r=>r.json())
  .then(d=>{
    if(d.status==="ok"){
      UNIT=d.unit;
      login.style.display="none";
      content.style.display="block";
      unit.innerText="Unit Kerja: "+UNIT;
      loadData();
    } else alert("Login gagal");
  });
}

function loadData(){
 fetch(`${API}?action=getData&unit=${UNIT}`)
  .then(r=>r.json())
  .then(data=>{
    const tb=document.querySelector("#tbl tbody");
    tb.innerHTML="";
    data.forEach(r=>{
      tb.innerHTML+=`
      <tr>
        <td><img src="${r.foto}"></td>
        <td>${r.nama}</td><td>${r.nik}</td><td>${r.nip}</td>
        <td>${r.wa}</td><td>${r.unit}</td>
        <td>${r.jenis}</td><td>${r.jenjang}</td>
        <td>${r.pangkat}</td><td>${r.pak}</td>
        <td>${r.str}</td><td>${r.kategori}</td>
        <td>${r.jabatan_tujuan}</td>
        <td>${r.jenjang_tujuan}</td>
        <td>${r.keputusan}</td>
      </tr>`;
    });
    $('#tbl').DataTable();
    chart(data);
  });
}

function chart(data){
 const j={},k={};
 data.forEach(d=>{
  j[d.jenjang]=(j[d.jenjang]||0)+1;
  k[d.keputusan]=(k[d.keputusan]||0)+1;
 });

 new Chart(chart1,{type:"bar",data:{labels:Object.keys(j),datasets:[{data:Object.values(j)}]}});
 new Chart(chart2,{type:"pie",data:{labels:Object.keys(k),datasets:[{data:Object.values(k)}]}});
}

function exportPDF(){
 html2pdf().from(document.querySelector(".content"))
 .set({filename:`Laporan_${UNIT}.pdf`,jsPDF:{orientation:"landscape"}})
 .save();
}

function tv(){
 document.documentElement.requestFullscreen();
 setInterval(()=>window.scrollTo(0,document.body.scrollHeight),8000);
}
</script>

</body>
</html>
