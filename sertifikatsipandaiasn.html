<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIPANDAI-ASN - Sistem Informasi Pelatihan dan Diklat ASN</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 28px;
      font-weight: bold;
    }
    
    .logo span {
      color: #f39c12;
    }
    
    .nav {
      display: flex;
      gap: 20px;
    }
    
    .nav a {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 5px;
      transition: background 0.3s;
    }
    
    .nav a:hover, .nav a.active {
      background: rgba(255,255,255,0.2);
    }
    
    /* Main Content */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    /* Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .stat-card .number {
      font-size: 36px;
      font-weight: bold;
      color: #1e3c72;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tab {
      padding: 15px 30px;
      cursor: pointer;
      background: #f0f0f0;
      border: none;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .tab.active {
      background: #1e3c72;
      color: white;
    }
    
    .tab:hover:not(.active) {
      background: #e0e0e0;
    }
    
    /* Content Panel */
    .content-panel {
      background: white;
      padding: 30px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 400px;
    }
    
    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #1e3c72;
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .data-table tr:hover {
      background: #f5f5f5;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #1e3c72;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2a5298;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1e3c72;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Alert */
    .alert {
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .alert-error {
      background: #fee;
      color: #c33;
      border: 1px solid #fcc;
    }
    
    .alert-success {
      background: #efe;
      color: #3c3;
      border: 1px solid #cfc;
    }
    
    /* Gallery */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .gallery-item {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .gallery-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    
    .gallery-item .content {
      padding: 15px;
    }
    
    .gallery-item h4 {
      margin-bottom: 10px;
      color: #1e3c72;
    }
    
    .gallery-item p {
      font-size: 14px;
      color: #666;
    }
    
    /* Footer */
    .footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 50px;
    }
    
    /* Error Message */
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">SIPANDAI<span>-ASN</span></div>
      <nav class="nav">
        <a href="#" class="active" onclick="showTab('dashboard')">Dashboard</a>
        <a href="#" onclick="showTab('kegatan')">Activities</a>
        <a href="#" onclick="showTab('galeri')">Gallery</a>
        <a href="#" onclick="showTab('materi')">Materials</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Total Activities</h3>
        <div class="number" id="totalKegatan">-</div>
      </div>
      <div class="stat-card">
        <h3>Total Participants</h3>
        <div class="number" id="totalPeserta">-</div>
      </div>
      <div class="stat-card">
        <h3>Total Speakers</h3>
        <div class="number" id="totalNarasumber">-</div>
      </div>
      <div class="stat-card">
        <h3>Certificates</h3>
        <div class="number" id="totalSertifikat">-</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="showTab('kegatan')">Activities</button>
      <button class="tab" onclick="showTab('galeri')">Gallery</button>
      <button class="tab" onclick="showTab('materi')">Materials</button>
    </div>

    <!-- Content Panel -->
    <div class="content-panel" id="contentPanel">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2024 SIPANDAI-ASN - Sistem Informasi Pelatihan dan Diklat ASN</p>
    <p>Data diambil secara real-time dari Google Sheets</p>
  </footer>

  <script>
    // ============================================
    // CONFIGURATION - REPLACE WITH YOUR VALUES
    // ============================================
    
    // Google Apps Script Web App URL
    // Replace 'YOUR_DEPLOYMENT_ID' with your actual deployment ID
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx-TYtNVZoc2hib1Ih-gPM_3t2wj-U419-ED7yRFQdRmvWoezySr6MtMWcOwafbKHYh/exec';
    
    // Spreadsheet ID
    const SPREADSHEET_ID = '1a25Gdo6k3VCBD3F7oueAM6EpT6KEsQkBDn4Vhwbum6s';
    
    // ============================================
    // DATA FETCHING FUNCTIONS (JSONP for CORS)
    // ============================================
    
    // JSONP callback counter for unique callback names
    let callbackCounter = 0;
    
    /**
     * Fetch data from Google Sheets using JSONP (bypasses CORS)
     */
    function fetchSheetDataJSONP(sheetName, action = 'read') {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + (++callbackCounter);
        const url = `${GOOGLE_SHEETS_URL}?sheetName=${encodeURIComponent(sheetName)}&action=${action}&spreadsheetId=${SPREADSHEET_ID}&callback=${callbackName}`;
        
        console.log('Fetching from:', url);
        
        // Create script element for JSONP request
        const script = document.createElement('script');
        script.src = url;
        
        // Handle successful response
        window[callbackName] = function(response) {
          console.log('Response:', response);
          cleanup();
          if (response && response.success) {
            resolve(response.data || []);
          } else if (response && response.error) {
            reject(new Error(response.error));
          } else {
            reject(new Error('Unknown error - response: ' + JSON.stringify(response)));
          }
        };
        
        // Handle error
        script.onerror = function(e) {
          console.error('Script load error:', e);
          cleanup();
          reject(new Error('Failed to load data - check console for details'));
        };
        
        // Cleanup function
        function cleanup() {
          if (script.parentNode) {
            script.parentNode.removeChild(script);
          }
          delete window[callbackName];
        };
        
        // Add script to head to start request
        document.head.appendChild(script);
        
        // Timeout after 15 seconds
        setTimeout(() => {
          if (window[callbackName]) {
            cleanup();
            reject(new Error('Request timeout after 15 seconds'));
          }
        }, 15000);
      });
    }
    
    /**
     * Fetch dashboard statistics
     */
    async function fetchDashboardStats() {
      try {
        const response = await fetch(`${GOOGLE_SHEETS_URL}?action=getStats&spreadsheetId=${SPREADSHEET_ID}&callback=statsCallback`);
        
        // Use JSONP for stats too
        return new Promise((resolve, reject) => {
          const callbackName = 'stats_callback_' + (++callbackCounter);
          const script = document.createElement('script');
          script.src = `${GOOGLE_SHEETS_URL}?action=getStats&spreadsheetId=${SPREADSHEET_ID}&callback=${callbackName}`;
          
          window[callbackName] = function(response) {
            document.head.removeChild(script);
            delete window[callbackName];
            if (response && response.success) {
              resolve(response.stats);
            } else {
              reject(new Error(response?.error || 'Failed to get stats'));
            }
          };
          
          script.onerror = () => {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('Failed to load stats'));
          };
          
          document.head.appendChild(script);
          
          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('Stats request timeout'));
            }
          }, 10000);
        });
      } catch (error) {
        console.error('Error fetching stats:', error);
        return null;
      }
    }
    
    // ============================================
    // UI FUNCTIONS
    // ============================================
    
    // Current active tab
    let currentTab = 'dashboard';
    
    /**
     * Show selected tab
     */
    function showTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Load content
      loadTabContent(tabName);
    }
    
    /**
     * Load content for selected tab
     */
    async function loadTabContent(tabName) {
      const panel = document.getElementById('contentPanel');
      
      switch(tabName) {
        case 'dashboard':
          await loadDashboard(panel);
          break;
        case 'kegatan':
          await loadKegatan(panel);
          break;
        case 'galeri':
          await loadGaleri(panel);
          break;
        case 'materi':
          await loadMateri(panel);
          break;
      }
    }
    
    /**
     * Load dashboard content
     */
    async function loadDashboard(panel) {
      panel.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading dashboard...</div>';
      
      try {
        // Fetch stats using JSONP
        const stats = await new Promise((resolve, reject) => {
          const callbackName = 'dash_callback_' + (++callbackCounter);
          const script = document.createElement('script');
          script.src = `${GOOGLE_SHEETS_URL}?action=getStats&spreadsheetId=${SPREADSHEET_ID}&callback=${callbackName}`;
          
          window[callbackName] = function(response) {
            document.head.removeChild(script);
            delete window[callbackName];
            if (response && response.success) {
              resolve(response.stats);
            } else {
              resolve({ total_kegatan: 0, total_peserta: 0, total_narasumber: 0, total_sertifikat: 0, recent_activities: [] });
            }
          };
          
          script.onerror = () => {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve({ total_kegatan: 0, total_peserta: 0, total_narasumber: 0, total_sertifikat: 0, recent_activities: [] });
          };
          
          document.head.appendChild(script);
        });
        
        // Update stats cards
        document.getElementById('totalKegatan').textContent = stats.total_kegatan || 0;
        document.getElementById('totalPeserta').textContent = stats.total_peserta || 0;
        document.getElementById('totalNarasumber').textContent = stats.total_narasumber || 0;
        document.getElementById('totalSertifikat').textContent = stats.total_sertifikat || 0;
        
        // Show recent activities
        let recentHtml = '<h3 style="margin: 20px 0 15px;">Recent Activities</h3>';
        
        if (stats.recent_activities && stats.recent_activities.length > 0) {
          recentHtml += '<table class="data-table"><thead><tr><th>ID</th><th>Activity Name</th><th>Date</th></tr></thead><tbody>';
          stats.recent_activities.forEach(activity => {
            recentHtml += `<tr><td>${activity.id || '-'}</td><td>${activity.nama || '-'}</td><td>${activity.tanggal || '-'}</td></tr>`;
          });
          recentHtml += '</tbody></table>';
        } else {
          recentHtml += '<p>No recent activities</p>';
        }
        
        panel.innerHTML = `
          <h2>Dashboard Overview</h2>
          <p>Welcome to SIPANDAI-ASN. This dashboard shows real-time data from Google Sheets.</p>
          ${recentHtml}
        `;
        
      } catch (error) {
        panel.innerHTML = `
          <div class="error-message">
            <strong>Error loading dashboard:</strong> ${error.message}<br>
            <small>Make sure the Google Apps Script is deployed and the URL is correct.</small>
          </div>
        `;
      }
    }
    
    /**
     * Load activities (Kegatan)
     */
    async function loadKegatan(panel) {
      panel.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading activities...</div>';
      
      try {
        console.log('Loading activities from sheet: Kegatan');
        const data = await fetchSheetDataJSONP('Kegatan');
        console.log('Activities data:', data);
        
        if (!data || data.length === 0) {
          panel.innerHTML = '<h2>Activities</h2><p>No activities found. Please add data to the "Kegatan" sheet in Google Sheets.</p>';
          return;
        }
        
        let html = '<h2>Activities</h2>';
        html += '<table class="data-table">';
        html += '<thead><tr>';
        
        // Get headers from first object
        const headers = Object.keys(data[0]);
        headers.forEach(header => {
          html += `<th>${header}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        data.forEach(row => {
          html += '<tr>';
          headers.forEach(header => {
            html += `<td>${row[header] || '-'}</td>`;
          });
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        panel.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading activities:', error);
        panel.innerHTML = `
          <div class="error-message">
            <strong>Error loading activities:</strong> ${error.message}<br><br>
            <strong>Possible causes:</strong><br>
            1. Sheet name might be different (check case)<br>
            2. No data in the "Kegatan" sheet<br>
            3. Google Apps Script not deployed correctly<br>
            <br>
            <strong>Check browser console (F12) for more details.</strong>
          </div>
        `;
      }
    }
    
    /**
     * Load gallery (Galeri)
     */
    async function loadGaleri(panel) {
      panel.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading gallery...</div>';
      
      try {
        const data = await fetchSheetDataJSONP('Galeri');
        
        if (!data || data.length === 0) {
          panel.innerHTML = '<h2>Gallery</h2><p>No gallery items found.</p>';
          return;
        }
        
        let html = '<h2>Gallery</h2>';
        html += '<div class="gallery-grid">';
        
        data.forEach(item => {
          const imageUrl = item.gambar || 'https://via.placeholder.com/300x200?text=No+Image';
          html += `
            <div class="gallery-item">
              <img src="${imageUrl}" alt="${item.judul || 'Gallery Image'}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
              <div class="content">
                <h4>${item.judul || 'Untitled'}</h4>
                <p>${item.deskripsi || ''}</p>
                <small>${item.tanggal || ''}</small>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        panel.innerHTML = html;
        
      } catch (error) {
        panel.innerHTML = `
          <div class="error-message">
            <strong>Error loading gallery:</strong> ${error.message}
          </div>
        `;
      }
    }
    
    /**
     * Load materials (Materi)
     */
    async function loadMateri(panel) {
      panel.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading materials...</div>';
      
      try {
        const data = await fetchSheetDataJSONP('Materi');
        
        if (!data || data.length === 0) {
          panel.innerHTML = '<h2>Materials</h2><p>No materials found.</p>';
          return;
        }
        
        let html = '<h2>Training Materials</h2>';
        html += '<table class="data-table">';
        html += '<thead><tr>';
        
        const headers = Object.keys(data[0]);
        headers.forEach(header => {
          html += `<th>${header}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        data.forEach(row => {
          html += '<tr>';
          headers.forEach(header => {
            html += `<td>${row[header] || '-'}</td>`;
          });
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        panel.innerHTML = html;
        
      } catch (error) {
        panel.innerHTML = `
          <div class="error-message">
            <strong>Error loading materials:</strong> ${error.message}
          </div>
        `;
      }
    }
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadTabContent('dashboard');
    });
  </script>
</body>
</html>
