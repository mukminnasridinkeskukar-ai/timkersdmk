<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SDM Command Center | Dinkes Kukar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#020617;--panel:#0f172a;--border:#1e293b;
  --text:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;
  --green:#22c55e;--red:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:var(--bg);color:var(--text)}
header{padding:20px;border-bottom:1px solid var(--border)}
header h1{margin:0;font-size:22px;font-weight:800}
header small{color:var(--muted)}
.container{max-width:1600px;margin:auto;padding:22px}
.grid{display:grid;gap:18px}
.grid.kpi{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.grid.main{grid-template-columns:2fr 1fr}
.card,.panel{
  background:linear-gradient(180deg,var(--panel),#020617);
  border:1px solid var(--border);border-radius:22px;padding:18px
}
.card h4{margin:0;font-size:13px;color:var(--muted)}
.card .v{margin-top:6px;font-size:30px;font-weight:800}
.badge{font-size:12px;padding:4px 8px;border-radius:10px}
.ok{background:rgba(34,197,94,.2);color:#22c55e}
.bad{background:rgba(239,68,68,.2);color:#ef4444}
button{
  background:#2563eb;color:#fff;border:0;
  padding:10px 14px;border-radius:10px;font-weight:700;
}
@media print{
  button,.filter{display:none}
  body{background:#fff;color:#000}
}
</style>
</head>

<body>

<header>
  <h1>üõ∞Ô∏è SDM Kesehatan ‚Äì Command Center</h1>
  <small>Dinas Kesehatan Kabupaten Kutai Kartanegara</small>
</header>

<div class="container">

<div class="filter" style="margin-bottom:12px">
  <button onclick="exportPDF()">üìÑ Export PDF Laporan Kadis</button>
</div>

<!-- KPI TOP 6 -->
<div class="grid kpi" id="kpi"></div>

<!-- GRAFIK -->
<div class="grid main" style="margin-top:20px">
  <div class="panel">
    <h3>Komposisi SDMK</h3>
    <canvas id="donut"></canvas>
  </div>
  <div class="panel">
    <h3>Status SDMK Utama</h3>
    <div id="status"></div>
  </div>
</div>

</div>

<script>
/* ================= KONFIG ================= */
const API_URL="https://script.google.com/macros/s/AKfycbxwqMys-l6d4jrPaU-WmUruuAKL47s2PEmjQybUzybf-Yc5DkT8ojUblozBhFciO4A3/exec?page=api";
const PENDUDUK=780000;
const STANDAR={
  "Dokter":2500,
  "Dokter Gigi":5000,
  "Perawat":417,
  "Bidan":500,
  "Apoteker":1099,
  "Nutrisionis":2857,
  "Tenaga Sanitasi Lingkungan":4762
};

/* ================= DATA ================= */
let RAW = [];
let chartObj = null;

fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    RAW = data;
    initFilter();
    render();
  });

/* ================= INIT FILTER ================= */
function initFilter(){
  const tahun = [...new Set(RAW.map(d => d.Tahun))].sort();
  const bulan = [...new Set(RAW.map(d => d.Bulan))];
  const unit  = [...new Set(RAW.map(d => d.Unit))].sort();

  fTahun.innerHTML =
    `<option value="">Semua Tahun</option>` +
    tahun.map(x => `<option value="${x}">${x}</option>`).join("");

  fBulan.innerHTML =
    `<option value="">Semua Bulan</option>` +
    bulan.map(x => `<option value="${x}">${x}</option>`).join("");

  fUnit.innerHTML =
    `<option value="">Semua Unit</option>` +
    unit.map(x => `<option value="${x}">${x}</option>`).join("");

  // üîë KUNCI FILTER HIDUP
  fTahun.onchange =
  fBulan.onchange =
  fUnit.onchange = render;
}

/* ================= RENDER (PAKAI DATA TERFILTER) ================= */
function render(){
  const t = fTahun.value;
  const b = fBulan.value;
  const u = fUnit.value;

  // FILTER BULAN & UNIT DI SINI
  const data = RAW.filter(d =>
    (!t || d.Tahun == t) &&
    (!b || d.Bulan == b) &&
    (!u || d.Unit  == u)
  );

  /* ================= REKAP ================= */
  const sum = {};
  data.forEach(d => {
    sum[d.Jenis] = (sum[d.Jenis] || 0) + Number(d.Jumlah);
  });

  const entries = Object.entries(sum).sort((a,b)=>b[1]-a[1]);

  /* ================= KPI TOP 6 ================= */
  const kpi = document.getElementById("kpi");
  const total = entries.reduce((a,b)=>a+b[1],0);

  kpi.innerHTML =
    `<div class="card">
      <h4>Total SDM</h4>
      <div class="v">${total}</div>
    </div>`;

  entries.slice(0,6).forEach(e=>{
    kpi.innerHTML += `
      <div class="card">
        <h4>${e[0]}</h4>
        <div class="v">${e[1]}</div>
      </div>`;
  });

  /* ================= STATUS SURPLUS / DEFISIT ================= */
  const s = document.getElementById("status");
  s.innerHTML = "";

  Object.keys(STANDAR).forEach(j=>{
    const ideal = Math.ceil(PENDUDUK / STANDAR[j]);
    const aktual = sum[j] || 0;
    const ok = aktual >= ideal;

    s.innerHTML += `
      <p>
        <b>${j}</b> :
        ${aktual} / ideal ${ideal}
        <span class="badge ${ok ? 'ok' : 'bad'}">
          ${ok ? 'Surplus' : 'Defisit'}
        </span>
      </p>`;
  });

  /* ================= GRAFIK ================= */
  if(chartObj) chartObj.destroy();

  chartObj = new Chart(donut,{
    type:"doughnut",
    data:{
      labels:entries.map(e=>e[0]),
      datasets:[{
        data:entries.map(e=>e[1]),
        backgroundColor:entries.map((_,i)=>`hsl(${i*11},70%,60%)`)
      }]
    },
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

/* ================= PDF ================= */
function exportPDF(){
  const d=new Date().toISOString().slice(0,10);
  document.title=`Laporan_SDM_Kesehatan_Kukar_${d}`;
  window.print();
}
</script>


</body>
</html>
