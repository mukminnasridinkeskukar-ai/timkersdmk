<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard SDM Kesehatan</title>
<meta name="viewport" content="width=device-width">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:Inter,Arial;
}
h1{font-size:42px;text-align:center;margin:24px 0}
.filter{
  display:flex;gap:16px;justify-content:center;flex-wrap:wrap
}
select{
  font-size:20px;
  padding:14px;
  border-radius:12px;
  background:#020617;
  color:#fff;
  border:2px solid #1e293b;
}
.kpi{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
  padding:24px;
}
.card{
  background:#0f172a;
  border-radius:24px;
  padding:24px;
  text-align:center;
}
.card h3{font-size:22px;margin:0}
.card .v{font-size:48px;font-weight:900}
.bad{color:#ef4444}
.ok{color:#22c55e}
section{padding:30px}
canvas{max-height:520px}
</style>
</head>

<body>

<h1>ðŸ“Š DASHBOARD SDM KESEHATAN</h1>

<div class="filter">
  <select id="fUnit"></select>
  <select id="fBulan"></select>
  <select id="fJenis"></select>
</div>

<section class="kpi" id="kpi"></section>

<section>
  <canvas id="chart"></canvas>
</section>

<script>
/* ================= KONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxwqMys-l6d4jrPaU-WmUruuAKL47s2PEmjQybUzybf-Yc5DkT8ojUblozBhFciO4A3/exec?page=api";
const PENDUDUK = 780000;

let RAW = [];
let chartObj = null;

/* ================= LOAD DATA ================= */
fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    console.log("DATA API:", data);   // ðŸ” DEBUG
    RAW = data;
    initFilter();
    render();
  })
  .catch(err => {
    console.error("Gagal load data:", err);
  });

/* ================= INIT FILTER ================= */
function initFilter(){
  fill(fUnit, "Unit", "Semua Unit");
  fill(fBulan, "Bulan", "Semua Bulan");
  fill(fJenis, "Jenis", "Semua Jenis SDM");

  fUnit.onchange =
  fBulan.onchange =
  fJenis.onchange = render;
}

function fill(el, key, label){
  const values = [...new Set(RAW.map(d => d[key]).filter(Boolean))];
  el.innerHTML =
    `<option value="">${label}</option>` +
    values.map(v => `<option value="${v}">${v}</option>`).join("");
}

/* ================= RENDER ================= */
function render(){
  const u = fUnit.value;
  const b = fBulan.value;
  const j = fJenis.value;

  const data = RAW.filter(d =>
    (!u || d.Unit === u) &&
    (!b || d.Bulan === b) &&
    (!j || d.Jenis === j)
  );

  /* KPI */
  const sum = {};
  data.forEach(d => {
    sum[d.Jenis] = (sum[d.Jenis] || 0) + Number(d.Jumlah);
  });

  const entries = Object.entries(sum).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((a,b)=>a+b[1],0);

  kpi.innerHTML = `
    <div class="card">
      <h4>TOTAL SDM</h4>
      <div class="v">${total}</div>
    </div>
  `;

  entries.slice(0,5).forEach(e=>{
    kpi.innerHTML += `
      <div class="card">
        <h4>${e[0].toUpperCase()}</h4>
        <div class="v">${e[1]}</div>
      </div>
    `;
  });

  /* CHART */
  if(chartObj) chartObj.destroy();

  chartObj = new Chart(chart,{
    type:"doughnut",
    data:{
      labels:entries.map(e=>e[0]),
      datasets:[{
        data:entries.map(e=>e[1]),
        backgroundColor:entries.map((_,i)=>`hsl(${i*15},80%,60%)`)
      }]
    },
    options:{
      plugins:{
        legend:{
          position:"bottom",
          labels:{
            color:"#fff",
            font:{size:18,weight:"bold"}
          }
        }
      }
    }
  });
}
</script>


</body>
</html>
