<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard SDM Kesehatan</title>
<meta name="viewport" content="width=device-width">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:Inter,Arial;
}
h1{font-size:42px;text-align:center;margin:24px 0}
.filter{
  display:flex;gap:16px;justify-content:center;flex-wrap:wrap
}
select{
  font-size:20px;
  padding:14px;
  border-radius:12px;
  background:#020617;
  color:#fff;
  border:2px solid #1e293b;
}
.kpi{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
  padding:24px;
}
.card{
  background:#0f172a;
  border-radius:24px;
  padding:24px;
  text-align:center;
}
.card h3{font-size:22px;margin:0}
.card .v{font-size:48px;font-weight:900}
.bad{color:#ef4444}
.ok{color:#22c55e}
section{padding:30px}
canvas{max-height:520px}
</style>
</head>

<body>

<h1>ðŸ“Š DASHBOARD SDM KESEHATAN</h1>

<div class="filter">
  <select id="fUnit"></select>
  <select id="fBulan"></select>
  <select id="fJenis"></select>
</div>

<section class="kpi" id="kpi"></section>

<section>
  <canvas id="chart"></canvas>
</section>

<script>
/* ================= KONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxwqMys-l6d4jrPaU-WmUruuAKL47s2PEmjQybUzybf-Yc5DkT8ojUblozBhFciO4A3/exec?page=api";
const PENDUDUK = 780000;

// Rasio = 1 tenaga per X penduduk
const RASIO = {
  "Dokter": 1000,
  "Dokter Gigi": 5000,
  "Perawat": 417,
  "Bidan": 500,
  "Apoteker": 1099,
  "Nutrisionis": 2857,
  "Tenaga Sanitasi Lingkungan": 4762
};

const TV_MODE = new URLSearchParams(location.search).get("tv") === "1";
const SLIDE_INTERVAL = 10000;

/* ================= VAR ================= */
let RAW = [];
let chartObj = null;
let slideIndex = 0;
let unitList = [];
let jenisList = [];

/* ================= LOAD DATA ================= */
fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    RAW = data;
    unitList = [...new Set(RAW.map(d => d.Unit))];
    jenisList = [...new Set(RAW.map(d => d.Jenis))];
    initFilter();
    render();
    if (TV_MODE) startTV();
  });

/* ================= FILTER ================= */
function initFilter(){
  fill(fUnit, "Unit", "Semua Unit");
  fill(fBulan, "Bulan", "Semua Bulan");
  fill(fJenis, "Jenis", "Semua Jenis SDM");

  if (!TV_MODE) {
    fUnit.onchange =
    fBulan.onchange =
    fJenis.onchange = render;
  }
}

function fill(el, key, label){
  const values = [...new Set(RAW.map(d => d[key]).filter(Boolean))];
  el.innerHTML =
    `<option value="">${label}</option>` +
    values.map(v => `<option value="${v}">${v}</option>`).join("");
}

/* ================= RENDER ================= */
function render(){
  const u = fUnit.value;
  const b = fBulan.value;
  const j = fJenis.value;

  const data = RAW.filter(d =>
    (!u || d.Unit === u) &&
    (!b || d.Bulan === b) &&
    (!j || d.Jenis === j)
  );

  // ===== KPI =====
  const sum = {};
  data.forEach(d => {
    sum[d.Jenis] = (sum[d.Jenis] || 0) + Number(d.Jumlah);
  });

  const entries = Object.entries(sum).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((a,b)=>a+b[1],0);

  kpi.innerHTML = `
    <div class="card">
      <h4>TOTAL SDM</h4>
      <div class="v">${total}</div>
    </div>
  `;

  entries.slice(0,5).forEach(([jenis,jumlah])=>{
    let statusHTML = "";
    if (RASIO[jenis]) {
      const ideal = Math.ceil(PENDUDUK / RASIO[jenis]);
      const defisit = ideal - jumlah;
      statusHTML = defisit > 0
        ? `<div style="color:#ef4444;font-size:18px">Defisit ${defisit}</div>`
        : `<div style="color:#22c55e;font-size:18px">Surplus</div>`;
    }

    kpi.innerHTML += `
      <div class="card">
        <h4>${jenis.toUpperCase()}</h4>
        <div class="v">${jumlah}</div>
        ${statusHTML}
      </div>
    `;
  });

  // ===== CHART =====
  if(chartObj) chartObj.destroy();
  chartObj = new Chart(chart,{
    type:"doughnut",
    data:{
      labels:entries.map(e=>e[0]),
      datasets:[{
        data:entries.map(e=>e[1]),
        backgroundColor:entries.map((_,i)=>`hsl(${i*15},80%,60%)`)
      }]
    },
    options:{
      plugins:{
        legend:{
          position:"bottom",
          labels:{
            color:"#fff",
            font:{size:18,weight:"bold"}
          }
        }
      }
    }
  });
}

/* ================= TV WALL ================= */
function startTV(){
  setInterval(()=>{
    slideIndex++;

    // Slide 1: Semua data
    if (slideIndex % 3 === 0) {
      fUnit.value = "";
      fJenis.value = "";
    }

    // Slide 2: Rotasi Unit
    if (slideIndex % 3 === 1) {
      fUnit.value = unitList[slideIndex % unitList.length];
      fJenis.value = "";
    }

    // Slide 3: Rotasi Jenis SDM
    if (slideIndex % 3 === 2) {
      fJenis.value = jenisList[slideIndex % jenisList.length];
      fUnit.value = "";
    }

    render();
  }, SLIDE_INTERVAL);
}
</script>

</body>
</html>
