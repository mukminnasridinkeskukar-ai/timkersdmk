<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SDMK</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: linear-gradient(135deg, #0066cc, #004999); color: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; }
        header h1 { font-size: 24px; margin-bottom: 5px; }
        header p { opacity: 0.9; font-size: 13px; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: #666; }
        .filter-group input, .filter-group select { padding: 10px 12px; border: 2px solid #e1e5eb; border-radius: 6px; font-size: 14px; min-width: 150px; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #0066cc; }
        .filter-group:first-child { flex-grow: 1; min-width: 250px; }
        .btn-reset { padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-reset:hover { background: #5a6268; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #0066cc; }
        .summary-card h4 { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }
        .summary-card .value { font-size: 28px; font-weight: bold; color: #333; }
        .summary-card.highlight { border-left-color: #28a745; }
        .data-table { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .data-table h3 { margin-bottom: 15px; color: #333; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e1e5eb; }
        table th { background: #f8f9fa; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #495057; }
        table tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 5px 12px; background: #e3f2fd; color: #0066cc; border-radius: 15px; font-weight: 600; }
        .chart-section { background: white; padding: 20px; border-radius: 10px; }
        .chart-section h3 { margin-bottom: 15px; color: #333; }
        .chart-wrap { height: 350px; }
        .status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .status.info { background: #e3f2fd; color: #0066cc; }
        .status.error { background: #ffebee; color: #c62828; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .config-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #ccc; }
        .config-section h3 { color: #333; margin-bottom: 15px; }
        .config-section input { width: 100%; padding: 12px; border: 2px solid #e1e5eb; border-radius: 6px; font-size: 14px; margin-bottom: 10px; }
        .config-section button { padding: 12px 24px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .config-section button:hover { background: #0052a3; }
        @media (max-width: 768px) { .filters { flex-direction: column; } .filter-group { width: 100%; } .filter-group input, .filter-group select { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard Tenaga Medis dan Kesehatan</h1>
            <p>Data SDMK berdasarkan Jenis | Source: Google Sheets via Web App</p>
        </header>
        
        <!-- Configuration Section -->
        <div class="config-section" id="configSection">
            <h3>Konfigurasi Web App URL</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 13px;">
                Masukkan URL Web App yang sudah di-deploy dari Google Apps Script.
            </p>
            <input type="text" id="webappUrl" placeholder="https://script.google.com/macros/s/AKfycbzspHFpBv76v-p_jYVUFpFRhQCB2tK33jnI7XHsSQqv_UBh6jnx182g9AhzB3NYHJb0/exec">
            <button onclick="saveAndLoad()">Simpan & Muat Data</button>
            <p id="configStatus" style="margin-top: 10px; font-size: 13px;"></p>
        </div>
        
        <div id="status" class="status info" style="display:none;"></div>
        
        <div class="filters" id="filtersSection" style="display:none;">
            <div class="filter-group">
                <label>Pencarian (Unit/Jenis)</label>
                <input type="text" id="search" placeholder="Cari..." oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Tahun</label>
                <select id="tahun" onchange="applyFilters()"><option value="">Semua</option></select>
            </div>
            <div class="filter-group">
                <label>Bulan</label>
                <select id="bulan" onchange="applyFilters()">
                    <option value="">Semua</option>
                    <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
                    <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
                    <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
                    <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Unit</label>
                <select id="unit" onchange="applyFilters()"><option value="">Semua</option></select>
            </div>
            <div class="filter-group">
                <label>Jenis</label>
                <select id="jenis" onchange="applyFilters()"><option value="">Semua</option></select>
            </div>
            <div class="filter-group">
                <button class="btn-reset" onclick="resetFilters()">Reset</button>
            </div>
        </div>
        
        <div class="summary" id="summary" style="display:none;">
            <div class="summary-card"><h4>Total Record</h4><div class="value" id="totalRecords">0</div></div>
            <div class="summary-card highlight"><h4>Total Jumlah</h4><div class="value" id="totalJumlah">0</div></div>
            <div class="summary-card"><h4>Jumlah Unit</h4><div class="value" id="totalUnit">0</div></div>
            <div class="summary-card"><h4>Jumlah Jenis</h4><div class="value" id="totalJenis">0</div></div>
        </div>
        
        <div class="data-table" id="dataTable" style="display:none;">
            <h3>Data Detail</h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr><th>No</th><th>Tahun</th><th>Bulan</th><th>Unit</th><th>Jenis</th><th>Jumlah</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display:none;">
            <h3>Visualisasi per Jenis</h3>
            <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
        </div>
    </div>

    <script>
        let allData = [];
        let chart = null;
        
        // Load saved WebApp URL on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedUrl = localStorage.getItem('sdmk_webapp_url');
            if (savedUrl) {
                document.getElementById('webappUrl').value = savedUrl;
                loadData();
            }
        });
        
        function saveAndLoad() {
            const url = document.getElementById('webappUrl').value.trim();
            if (!url) {
                document.getElementById('configStatus').textContent = 'Error: URL tidak boleh kosong';
                document.getElementById('configStatus').style.color = '#c62828';
                return;
            }
            
            // Save URL
            localStorage.setItem('sdmk_webapp_url', url);
            document.getElementById('configStatus').textContent = 'URL tersimpan!';
            document.getElementById('configStatus').style.color = '#2e7d32';
            
            // Load data
            loadData();
        }
        
        async function loadData() {
            const url = document.getElementById('webappUrl').value.trim();
            if (!url) {
                showStatus('Masukkan Web App URL terlebih dahulu', 'error');
                return;
            }
            
            showStatus('Memuat data dari Web App...', 'info');
            document.getElementById('configSection').style.display = 'none';
            
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Gagal mengambil data: ' + res.status);
                
                const text = await res.text();
                const data = JSON.parse(text);
                
                if (data.error) throw new Error(data.error);
                if (!Array.isArray(data) || data.length === 0) throw new Error('Data kosong');
                
                allData = data;
                
                // Validate required columns
                const firstRow = allData[0];
                const required = ['Tahun', 'Bulan', 'Unit', 'Jenis', 'Jumlah'];
                const missing = required.filter(col => !firstRow.hasOwnProperty(col));
                if (missing.length > 0) throw new Error('Kolom tidak lengkap: ' + missing.join(', '));
                
                populateFilters();
                applyFilters();
                showStatus('Data berhasil dimuat! (' + allData.length + ' record)', 'success');
                document.getElementById('filtersSection').style.display = 'flex';
            } catch (e) {
                console.error(e);
                showStatus('Error: ' + e.message, 'error');
                document.getElementById('configSection').style.display = 'block';
                document.getElementById('filtersSection').style.display = 'none';
            }
        }
        
        function populateFilters() {
            const tahun = [...new Set(allData.map(d => d.Tahun))].filter(Boolean).sort();
            const unit = [...new Set(allData.map(d => d.Unit))].filter(Boolean).sort();
            const jenis = [...new Set(allData.map(d => d.Jenis))].filter(Boolean).sort();
            
            fillSelect('tahun', tahun);
            fillSelect('unit', unit);
            fillSelect('jenis', jenis);
        }
        
        function fillSelect(id, values) {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">Semua</option>';
            values.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                sel.appendChild(opt);
            });
        }
        
        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const tahun = document.getElementById('tahun').value;
            const bulan = document.getElementById('bulan').value;
            const unit = document.getElementById('unit').value;
            const jenis = document.getElementById('jenis').value;
            
            const filtered = allData.filter(d => {
                const matchSearch = !search || (d.Unit && d.Unit.toLowerCase().includes(search)) || (d.Jenis && d.Jenis.toLowerCase().includes(search));
                const matchTahun = !tahun || d.Tahun === tahun;
                const matchBulan = !bulan || getMonthNum(d.Bulan) === parseInt(bulan);
                const matchUnit = !unit || d.Unit === unit;
                const matchJenis = !jenis || d.Jenis === jenis;
                return matchSearch && matchTahun && matchBulan && matchUnit && matchJenis;
            });
            
            updateSummary(filtered);
            renderTable(filtered);
            renderChart(filtered);
        }
        
        function getMonthNum(name) {
            if (!name) return 0;
            const m = { 'Januari':1,'Februari':2,'Maret':3,'April':4,'Mei':5,'Juni':6,'Juli':7,'Agustus':8,'September':9,'Oktober':10,'November':11,'Desember':12 };
            return m[name] || 0;
        }
        
        function updateSummary(data) {
            const summary = document.getElementById('summary');
            if (data.length === 0) { summary.style.display = 'none'; return; }
            summary.style.display = 'grid';
            
            document.getElementById('totalRecords').textContent = data.length;
            document.getElementById('totalJumlah').textContent = data.reduce((s, d) => s + (parseInt(d.Jumlah) || 0), 0).toLocaleString('id-ID');
            document.getElementById('totalUnit').textContent = [...new Set(data.map(d => d.Unit))].length;
            document.getElementById('totalJenis').textContent = [...new Set(data.map(d => d.Jenis))].length;
        }
        
        function renderTable(data) {
            const section = document.getElementById('dataTable');
            const tbody = document.getElementById('tableBody');
            if (data.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            
            const sorted = [...data].sort((a, b) => String(b.Tahun).localeCompare(String(a.Tahun)) || getMonthNum(b.Bulan) - getMonthNum(a.Bulan));
            tbody.innerHTML = sorted.map((d, i) => 
                '<tr><td>' + (i+1) + '</td><td>' + (d.Tahun || '') + '</td><td>' + (d.Bulan || '') + '</td><td>' + (d.Unit || '') + '</td><td>' + (d.Jenis || '') + '</td><td><span class="badge">' + (parseInt(d.Jumlah) || 0).toLocaleString('id-ID') + '</span></td></tr>'
            ).join('');
        }
        
        function renderChart(data) {
            const section = document.getElementById('chartSection');
            if (data.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            
            const byJenis = {};
            data.forEach(d => {
                const jenis = d.Jenis || 'Lainnya';
                byJenis[jenis] = (byJenis[jenis] || 0) + (parseInt(d.Jumlah) || 0);
            });
            
            const labels = Object.keys(byJenis);
            const values = Object.values(byJenis);
            
            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('mainChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Jumlah', data: values, backgroundColor: '#0066cc', borderColor: '#0066cc', borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Jumlah' } }, x: { title: { display: true, text: 'Jenis' } } } }
            });
        }
        
        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('tahun').value = '';
            document.getElementById('bulan').value = '';
            document.getElementById('unit').value = '';
            document.getElementById('jenis').value = '';
            applyFilters();
        }
        
        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status ' + type;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
