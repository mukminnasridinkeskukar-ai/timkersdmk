<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard SDM Kesehatan</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Segoe UI,Arial;
  background:linear-gradient(120deg,#020617,#0f172a,#1e293b);
  color:#fff;
}
.login{
  max-width:360px;
  margin:120px auto;
  background:#020617;
  padding:30px;
  border-radius:18px;
}
.login input,button{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:10px;
  border:none;
}
button{background:#38bdf8;font-weight:800;cursor:pointer}

#dash{display:none;padding:24px}
.tv-title{font-size:22px;font-weight:900;margin-bottom:12px}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.card{
  background:rgba(255,255,255,.08);
  padding:18px;
  border-radius:18px;
}
.card h4{margin:0;color:#7dd3fc;font-size:14px}
.card p{margin:8px 0;font-size:28px;font-weight:900}

.filters{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}
select{padding:10px;border-radius:10px;border:none}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
}
th{background:rgba(56,189,248,.25)}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <h2>üîê Login</h2>
  <input id="u" placeholder="Username">
  <input id="p" type="password" placeholder="Password">
  <button onclick="login()">MASUK</button>
  <div id="msg"></div>
</div>

<!-- DASHBOARD -->
<div id="dash">
  <div class="tv-title" id="tvTitle"></div>

  <div class="cards" id="cards">
    <div class="card"><h4>Kebutuhan</h4><p id="K">0</p></div>
    <div class="card"><h4>Pemangku</h4><p id="P">0</p></div>
    <div class="card"><h4>Lowongan</h4><p id="L">0</p></div>
    <div class="card"><h4>Status Nasional</h4><p id="S">-</p></div>
  </div>

  <canvas id="chart" height="90"></canvas>

  <div class="filters" id="filters">
    <select id="fI"></select>
    <select id="fJ"></select>
    <select id="fN"></select>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Instansi</th>
        <th>Jabfung</th>
        <th>Jenjang</th>
        <th>Kebutuhan</th>
        <th>Pemangku</th>
        <th>Lowongan</th>
        <th>Status</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ================== KONFIG ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbwNVrjroh9hKUhj4Uj6i2HYAEXmGvMTe3HikxmFXzqMYDQeP0HZoGEdL-EXIjOP9Zn5/exec";
/* ============================================ */

let raw=[], chart, slide=0;
const titles=[
  "üìä RINGKASAN NASIONAL",
  "üè• DEFISIT / SURPLUS PER INSTANSI",
  "üë®‚Äç‚öïÔ∏è DEFISIT / SURPLUS PER JABATAN FUNGSIONAL",
  "üìã DATA DETAIL"
];

// LOGIN
function login(){
  fetch(`${API_URL}?action=login&u=${u.value}&p=${p.value}`)
  .then(r=>r.json())
  .then(j=>{
    if(!j.status){msg.innerText="Login gagal";return;}
    loginBox.style.display="none";
    dash.style.display="block";
    loadData();
  })
  .catch(e=>msg.innerText="API error");
}

// LOAD DATA
function loadData(){
  fetch(`${API_URL}?action=data`)
  .then(r=>r.json())
  .then(d=>{
    raw=d||[];
    initFilter();
    render();
    startTV();
  });
}

// FILTER
function initFilter(){
  fill(fI,"instansi");
  fill(fJ,"jabfung");
  fill(fN,"jenjang");
  document.querySelectorAll("select").forEach(s=>s.onchange=render);
}
function fill(sel,key){
  sel.innerHTML="<option value=''>SEMUA</option>";
  [...new Set(raw.map(x=>x[key]))].forEach(v=>{
    if(v) sel.innerHTML+=`<option>${v}</option>`;
  });
}

// RENDER
function render(){
  const d = raw.filter(x =>
    (!fI.value||x.instansi===fI.value) &&
    (!fJ.value||x.jabfung===fJ.value) &&
    (!fN.value||x.jenjang===fN.value)
  );

  let Kt=0,Pt=0,Lt=0,St=0;
  tbody.innerHTML="";
  d.forEach(x=>{
    Kt+=x.kebutuhan; Pt+=x.pemangku; Lt+=x.lowongan; St+=x.sisa;
    tbody.innerHTML+=`
      <tr>
        <td>${x.instansi}</td>
        <td>${x.jabfung}</td>
        <td>${x.jenjang}</td>
        <td>${x.kebutuhan}</td>
        <td>${x.pemangku}</td>
        <td>${x.lowongan}</td>
        <td style="color:${x.sisa>0?'#fb7185':'#4ade80'}">
          ${x.sisa>0?'DEFISIT':'SURPLUS'} (${x.sisa})
        </td>
        <td>${x.ket}</td>
      </tr>`;
  });

  K.innerText=Kt; P.innerText=Pt; L.innerText=Lt;
  S.innerText = St>0?"üî¥ DEFISIT NASIONAL":"üü¢ SURPLUS NASIONAL";
  S.style.color = St>0?"#fb7185":"#4ade80";

  drawNasional(Kt,Pt,Lt,St);
}

// GRAFIK
function drawNasional(K,P,L,S){
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{
      labels:["Kebutuhan","Pemangku","Lowongan","Sisa"],
      datasets:[{
        data:[K,P,L,S],
        backgroundColor:["#38bdf8","#4ade80","#facc15",S>0?"#fb7185":"#4ade80"]
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

function groupSum(key){
  const m={};
  raw.forEach(x=>m[x[key]]=(m[x[key]]||0)+x.sisa);
  return m;
}
function drawGroup(key,title){
  const o=groupSum(key);
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{
      labels:Object.keys(o),
      datasets:[{
        data:Object.values(o),
        backgroundColor:Object.values(o).map(v=>v>0?"#fb7185":"#4ade80")
      }]
    },
    options:{plugins:{legend:{display:false},title:{display:true,text:title,color:"#fff"}}}
  });
}

// TV WALL
function startTV(){
  setInterval(()=>{
    slide=(slide+1)%4;
    tvTitle.innerText=titles[slide];
    document.body.requestFullscreen?.();

    cards.style.display = slide===0?"grid":"none";
    filters.style.display = slide===3?"flex":"none";
    tbl.style.display = slide===3?"table":"none";

    if(slide===1) drawGroup("instansi","Defisit / Surplus per Instansi");
    if(slide===2) drawGroup("jabfung","Defisit / Surplus per Jabfung");
  },12000);
}
</script>

</body>
</html>
